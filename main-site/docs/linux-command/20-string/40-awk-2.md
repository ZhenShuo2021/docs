---
title: Unix/Linux çš„ awk æŒ‡ä»¤ä½¿ç”¨ï¼ˆä¸‹ï¼‰
sidebar_label: awk ä¸‹ç¯‡
tags:
  - Linux
  - Cheatsheet
keywords:
  - Linux
last_update:
  date: 2025-05-18T02:11:00+08:00
  author: zsl0621
first_publish:
  date: 2025-05-18T02:11:00+08:00
---

æœ¬æ–‡æ˜¯ awk æŒ‡ä»¤æ•™å­¸çš„ä¸‹ç¯‡ï¼Œç¯„ä¾‹ `log.txt` è«‹è¦‹[ä¸Šç¯‡](awk-1)ã€‚

> å¦‚æœæœ‰æŒ‡ä»¤ä¸èƒ½åŸ·è¡Œï¼Œè«‹å®‰è£ gnu ç‰ˆæœ¬çš„ awkï¼Œmacos è«‹ä½¿ç”¨ `brew install gawk` å®‰è£ä¸¦æ”¹ç‚º gawkã€‚

## ğŸ“˜ AWK ä¸­éšç¯‡ 2

### èˆ‡ shell å‘½ä»¤çµåˆ

AWK å¯ä»¥ä½¿ç”¨ `system()` å‡½æ•¸åŸ·è¡Œ shell å‘½ä»¤ï¼Œä¹Ÿå¯é€šé `|&` èˆ‡å¤–éƒ¨ç¨‹åºäº¤äº’ã€‚

åœ¨ AWK ä¸­åŸ·è¡Œç³»çµ±å‘½ä»¤ï¼š

```bash
awk '{
    command = "echo " $1 " | grep -o \"[0-9]\\+\""; 
    while (command | getline result) {
        print "IPæ•¸å­—éƒ¨åˆ†:", result
    }
    close(command)
}' log.txt | head -3
```

è¼¸å‡ºï¼š

```txt
IPæ•¸å­—éƒ¨åˆ†: 192
IPæ•¸å­—éƒ¨åˆ†: 168
IPæ•¸å­—éƒ¨åˆ†: 0
```

å°‡ AWK è™•ç†çµæœå­˜å…¥æª”æ¡ˆï¼š

```bash
awk 'BEGIN {system("echo æ—¥èªŒåˆ†æå ±å‘Š > report.txt")} 
     $9 == "403" {system("echo ç™¼ç¾ç¦æ­¢è¨ªå•: " $1 " å˜—è©¦è¨ªå• " $7 " >> report.txt")} 
     END {system("echo åˆ†æå®Œæˆ >> report.txt; cat report.txt")}'  log.txt
```

è¼¸å‡ºï¼š

```txt
æ—¥èªŒåˆ†æå ±å‘Š
ç™¼ç¾ç¦æ­¢è¨ªå•: 172.16.4.5 å˜—è©¦è¨ªå• /api/user/321
åˆ†æå®Œæˆ
```

ä½¿ç”¨ date å‘½ä»¤æ ¼å¼åŒ–æ—¥æœŸï¼š

```bash
awk '{
    split($4, dt, "[:+/]");
    cmd = "date -d \"" dt[2] "/" dt[3] "/" dt[4] " " dt[5] ":" dt[6] ":" dt[7] "\" +\"%Y-%m-%d %H:%M:%S\"";
    cmd | getline formatted_date;
    close(cmd);
    print "æ ¼å¼åŒ–æ—¥æœŸ:", formatted_date, "IP:", $1
}' log.txt | head -2
```

### å­—ä¸²å‡½æ•¸

AWK æä¾›äº†è±å¯Œçš„å­—ä¸²è™•ç†å‡½æ•¸ï¼š

- `length(str)`ï¼šè¿”å›å­—ä¸²é•·åº¦
- `index(str, substr)`ï¼šè¿”å›å­å­—ä¸²åœ¨å­—ä¸²ä¸­çš„ä½ç½®
- `substr(str, pos, len)`ï¼šå¾å­—ä¸²ä¸­æå–å­å­—ä¸²
- `gsub(regexp, replacement, target)`ï¼šå…¨å±€æ›¿æ›
- `sub(regexp, replacement, target)`ï¼šæ›¿æ›ç¬¬ä¸€å€‹åŒ¹é…
- `match(str, regexp)`ï¼šæ¸¬è©¦å­—ä¸²æ˜¯å¦åŒ¹é…æ­£å‰‡è¡¨é”å¼
- `split(str, arr, delimiter)`ï¼šæ‹†åˆ†å­—ä¸²åˆ°é™£åˆ—

æå– HTTP æ–¹æ³•ï¼ˆå»é™¤å¼•è™Ÿï¼‰ï¼š

```bash
awk '{
    method = $6;
    gsub(/\"/, "", method);
    print "HTTPæ–¹æ³•:", method;
}' log.txt
```

è¼¸å‡ºï¼š

```txt
HTTPæ–¹æ³•: GET
HTTPæ–¹æ³•: GET
HTTPæ–¹æ³•: POST
HTTPæ–¹æ³•: GET
HTTPæ–¹æ³•: DELETE
HTTPæ–¹æ³•: POST
```

ä½¿ç”¨ substr æå–æ—¥æœŸéƒ¨åˆ†ï¼š

```bash
awk '{
    date_str = $4;
    date_only = substr(date_str, 2, 10);
    print "æ—¥æœŸ:", date_only;
}' log.txt
```

è¼¸å‡ºï¼š

```txt
æ—¥æœŸ: 17/May/202
æ—¥æœŸ: 17/May/202
æ—¥æœŸ: 17/May/202
æ—¥æœŸ: 17/May/202
æ—¥æœŸ: 17/May/202
æ—¥æœŸ: 18/May/202
```

åˆ†å‰² URL è·¯å¾‘ï¼š

```bash
awk '{
    url = $7;
    count = split(url, parts, "/");
    if (count > 1) {
        print "URLç¬¬ä¸€æ®µ:", parts[1] ? parts[1] : "(ç©º)";
        print "URLç¬¬äºŒæ®µ:", parts[2] ? parts[2] : "(ç©º)";
    }
}' log.txt
```

### æ•¸å­¸å‡½æ•¸

AWK æä¾›äº†è¨±å¤šæ•¸å­¸å‡½æ•¸ï¼š

- `int(x)`ï¼šå–æ•´æ•¸éƒ¨åˆ†
- `sqrt(x)`ï¼šå¹³æ–¹æ ¹
- `exp(x)`ï¼šæŒ‡æ•¸
- `log(x)`ï¼šè‡ªç„¶å°æ•¸
- `sin(x)`, `cos(x)`, `atan2(y,x)`ï¼šä¸‰è§’å‡½æ•¸
- `rand()`ï¼š0åˆ°1ä¹‹é–“çš„éš¨æ©Ÿæ•¸
- `srand(x)`ï¼šè¨­ç½®éš¨æ©Ÿæ•¸ç¨®å­

è¨ˆç®—éŸ¿æ‡‰å¤§å°çš„çµ±è¨ˆä¿¡æ¯ï¼š

```bash
awk 'BEGIN {min=999999; max=0; total=0} 
    {
        size = $10 + 0;  # è½‰æ›ç‚ºæ•¸å­—
        total += size;
        if (size < min && size > 0) min = size;
        if (size > max) max = size;
    } 
    END {
        avg = int(total/NR);
        print "æœ€å°éŸ¿æ‡‰:", min, "ä½å…ƒçµ„";
        print "æœ€å¤§éŸ¿æ‡‰:", max, "ä½å…ƒçµ„";
        print "å¹³å‡éŸ¿æ‡‰:", avg, "ä½å…ƒçµ„";
        print "ç¸½éŸ¿æ‡‰:", total, "ä½å…ƒçµ„";
    }' log.txt
```

è¼¸å‡ºï¼š

```txt
æœ€å°éŸ¿æ‡‰: 423 ä½å…ƒçµ„
æœ€å¤§éŸ¿æ‡‰: 9832 ä½å…ƒçµ„
å¹³å‡éŸ¿æ‡‰: 2874 ä½å…ƒçµ„
ç¸½éŸ¿æ‡‰: 17244 ä½å…ƒçµ„
```

å°æ•¸å€¼é€²è¡Œå››æ¨äº”å…¥ï¼š

```bash
awk '{
    kb = $10 / 1024;
    rounded_kb = int(kb * 100 + 0.5) / 100;
    if ($10 > 0) {
        print $7, "å¤§å°:", rounded_kb, "KB";
    }
}' log.txt
```

### è‡ªå®šç¾©å‡½æ•¸

AWK å…è¨±å®šç¾©è‡ªå·±çš„å‡½æ•¸ï¼Œå¢å¼·ç¨‹å¼çš„æ¨¡çµ„æ€§å’Œå¯è®€æ€§ï¼š

```txt
function å‡½æ•¸å(åƒæ•¸1, åƒæ•¸2, ...) {
    èªå¥;
    return è¿”å›å€¼;
}
```

å®šç¾©å‡½æ•¸è§£æ HTTP ç‹€æ…‹ç¢¼ï¼š

```bash
awk '
function status_desc(code) {
    if (code >= 200 && code < 300) return "æˆåŠŸ";
    else if (code >= 300 && code < 400) return "é‡å®šå‘";
    else if (code >= 400 && code < 500) return "å®¢æˆ¶ç«¯éŒ¯èª¤";
    else if (code >= 500) return "ä¼ºæœå™¨éŒ¯èª¤";
    else return "æœªçŸ¥";
}

{
    status = $9;
    desc = status_desc(status);
    print "è«‹æ±‚:", $7, "ç‹€æ…‹:", status, "-", desc;
}' log.txt
```

è¼¸å‡ºï¼š

```txt
è«‹æ±‚: / ç‹€æ…‹: 200 - æˆåŠŸ
è«‹æ±‚: /dashboard ç‹€æ…‹: 200 - æˆåŠŸ
è«‹æ±‚: /login ç‹€æ…‹: 302 - é‡å®šå‘
è«‹æ±‚: /assets/css/style.css ç‹€æ…‹: 304 - é‡å®šå‘
è«‹æ±‚: /api/user/321 ç‹€æ…‹: 403 - å®¢æˆ¶ç«¯éŒ¯èª¤
è«‹æ±‚: /api/upload ç‹€æ…‹: 201 - æˆåŠŸ
```

è¨ˆç®—å…©å€‹æ™‚é–“é»ä¹‹é–“çš„å·®å€¼ï¼ˆç§’ï¼‰ï¼š

```bash
awk '
function time_to_seconds(time_str) {
    split(time_str, t, ":");
    return t[1] * 3600 + t[2] * 60 + t[3];
}

function extract_time(datetime) {
    # å¾ [17/May/2025:21:14:12 æ ¼å¼æå–æ™‚é–“
    match(datetime, /[0-9]+:[0-9]+:[0-9]+/);
    return substr(datetime, RSTART, RLENGTH);
}

NR == 1 {first_time = extract_time($4)}
{
    current_time = extract_time($4);
    seconds_diff = time_to_seconds(current_time) - time_to_seconds(first_time);
    if (seconds_diff >= 0) {
        print "è«‹æ±‚é–“éš”:", seconds_diff, "ç§’";
    } else {
        # è·¨å¤©
        print "è«‹æ±‚é–“éš”: è·¨å¤©è¨ªå•";
    }
}' log.txt
```

## ğŸ“˜ AWK ä¸­éšç¯‡ 3

### é™£åˆ—ä½¿ç”¨

AWK ä¸­çš„é™£åˆ—æ˜¯å‹•æ…‹çš„ï¼Œç„¡éœ€äº‹å…ˆè²æ˜å¤§å°ã€‚é™£åˆ—ç´¢å¼•å¯ä»¥æ˜¯æ•¸å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ä¸²ã€‚

åŸºæœ¬é™£åˆ—ä½¿ç”¨ï¼š

```bash
awk 'BEGIN {
    # åˆå§‹åŒ–é™£åˆ—
    methods[1] = "GET";
    methods[2] = "POST";
    methods[3] = "PUT";
    methods[4] = "DELETE";
    
    print "æ”¯æ´çš„ HTTP æ–¹æ³•:";
    for (i = 1; i <= 4; i++) {
        print i, methods[i];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
æ”¯æ´çš„ HTTP æ–¹æ³•:
1 GET
2 POST
3 PUT
4 DELETE
```

å¾æ—¥èªŒä¸­å¡«å……é™£åˆ—ï¼š

```bash
awk '{
    # å­˜å„²æ¯è¡Œçš„ HTTP æ–¹æ³•
    gsub(/\"/, "", $6);
    methods[NR] = $6;
    
    # å­˜å„²æ¯è¡Œçš„ç‹€æ…‹ç¢¼
    codes[NR] = $9;
} END {
    print "è«‹æ±‚æ–¹æ³•èˆ‡ç‹€æ…‹ç¢¼å°ç…§:";
    for (i = 1; i <= NR; i++) {
        print i, methods[i], codes[i];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
è«‹æ±‚æ–¹æ³•èˆ‡ç‹€æ…‹ç¢¼å°ç…§:
1 GET 200
2 GET 200
3 POST 302
4 GET 304
5 DELETE 403
6 POST 201
```

ä½¿ç”¨é™£åˆ—æ”¶é›†çµ±è¨ˆä¿¡æ¯ï¼š

```bash
awk '{
    # è¨ˆç®—æ¯ç¨®ç‹€æ…‹ç¢¼çš„æ•¸é‡
    status_counts[$9]++;
} END {
    print "å„ç‹€æ…‹ç¢¼å‡ºç¾æ¬¡æ•¸:";
    for (status in status_counts) {
        print status, status_counts[status];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
å„ç‹€æ…‹ç¢¼å‡ºç¾æ¬¡æ•¸:
201 1
200 2
302 1
304 1
403 1
```

### é—œè¯é™£åˆ—

AWK çš„é™£åˆ—å¯¦éš›ä¸Šéƒ½æ˜¯é—œè¯é™£åˆ—ï¼ˆassociative arrayï¼‰æˆ–ç¨±ç‚ºå“ˆå¸Œè¡¨ï¼ˆhash tableï¼‰ï¼Œå³ç´¢å¼•å¯ä»¥æ˜¯ä»»ä½•å­—ä¸²è€Œéåƒ…é™æ–¼æ•¸å­—ã€‚

ç”¨ IP åœ°å€ä½œç‚ºç´¢å¼•ï¼š

```bash
awk '{
    # ç‚ºæ¯å€‹ IP åœ°å€è¨ˆæ•¸
    ip_counts[$1]++;
} END {
    print "å„ IP åœ°å€è«‹æ±‚æ¬¡æ•¸:";
    for (ip in ip_counts) {
        print ip, ip_counts[ip];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
å„ IP åœ°å€è«‹æ±‚æ¬¡æ•¸:
192.168.0.101 2
203.0.113.45 2
10.1.2.3 1
172.16.4.5 1
```

å¤šç¶­é—œè¯é™£åˆ—ï¼ˆä½¿ç”¨è¤‡åˆç´¢å¼•ï¼‰ï¼š

```bash
awk '{
    # è¨˜éŒ„æ¯å€‹ IP åœ°å€çš„æ¯ç¨® HTTP æ–¹æ³•çš„è«‹æ±‚æ¬¡æ•¸
    http_method = $6;
    gsub(/\"/, "", http_method);
    
    # ä½¿ç”¨è¤‡åˆç´¢å¼•
    ip_method_counts[$1 SUBSEP http_method]++;
} END {
    print "IPåœ°å€å’Œè«‹æ±‚æ–¹æ³•çµ„åˆçµ±è¨ˆ:";
    for (combo in ip_method_counts) {
        # åˆ†è§£è¤‡åˆç´¢å¼•
        split(combo, parts, SUBSEP);
        ip = parts[1];
        method = parts[2];
        
        print ip, method, ip_method_counts[combo];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
IPåœ°å€å’Œè«‹æ±‚æ–¹æ³•çµ„åˆçµ±è¨ˆ:
192.168.0.101 GET 2
203.0.113.45 POST 2
10.1.2.3 GET 1
172.16.4.5 DELETE 1
```

ä½¿ç”¨é—œè¯é™£åˆ—çµ±è¨ˆ URL è¨ªå•é‡ï¼š

```bash
awk '{
    # è¨ˆç®—æ¯å€‹ URL çš„è¨ªå•æ¬¡æ•¸
    urls[$7]++;
    
    # åŒæ™‚è¨˜éŒ„æ¯å€‹ URL çš„ç¸½éŸ¿æ‡‰å¤§å°
    url_sizes[$7] += $10;
} END {
    print "URL è¨ªå•çµ±è¨ˆ:";
    print "URL\tæ¬¡æ•¸\tç¸½å¤§å°\tå¹³å‡å¤§å°";
    for (url in urls) {
        avg_size = url_sizes[url] / urls[url];
        printf "%s\t%d\t%d\t%.1f\n", url, urls[url], url_sizes[url], avg_size;
    }
}' log.txt
```

### å¤šæª”æ¡ˆè™•ç†

AWK å¯ä»¥åŒæ™‚è™•ç†å¤šå€‹æª”æ¡ˆï¼Œä½¿ç”¨ç‰¹æ®Šè®Šæ•¸ `FILENAME` å¯ä»¥ç²å–ç•¶å‰è™•ç†çš„æª”æ¡ˆåã€‚

å‡è¨­å°‡æ—¥èªŒåˆ†å‰²ç‚ºå…©å€‹æª”æ¡ˆï¼š

```bash
# å…ˆå°‡æ—¥èªŒåˆ†å‰²ç‚ºå…©å€‹æª”æ¡ˆä»¥ä¾¿æ¼”ç¤º
awk 'NR <= 3 {print > "access_part1.log"} NR > 3 {print > "access_part2.log"}' log.txt

# ç„¶å¾Œè™•ç†é€™å…©å€‹æª”æ¡ˆ
awk '{
    print FILENAME, "è¡Œ", NR, ":", $1, $9;
    # æ¯å€‹æª”æ¡ˆçš„è¡Œæ•¸å–®ç¨è¨ˆæ•¸
    file_lines[FILENAME]++;
} END {
    print "å„æª”æ¡ˆè¡Œæ•¸:";
    for (file in file_lines) {
        print file, file_lines[file];
    }
}' access_part1.log access_part2.log
```

è¼¸å‡ºï¼š

```txt
access_part1.log è¡Œ 1 : 192.168.0.101 200
access_part1.log è¡Œ 2 : 192.168.0.101 200
access_part1.log è¡Œ 3 : 203.0.113.45 302
access_part2.log è¡Œ 1 : 10.1.2.3 304
access_part2.log è¡Œ 2 : 172.16.4.5 403
access_part2.log è¡Œ 3 : 203.0.113.45 201
å„æª”æ¡ˆè¡Œæ•¸:
access_part1.log 3
access_part2.log 3
```

ä½¿ç”¨ FNR å’Œ NR å€åˆ†ä¸åŒæª”æ¡ˆä¸­çš„è¨˜éŒ„ï¼š

```bash
awk '{
    # FNR æ˜¯æ¯å€‹æª”æ¡ˆä¸­çš„è¨˜éŒ„è™Ÿ
    # NR æ˜¯æ‰€æœ‰æª”æ¡ˆçš„ç¸½è¨˜éŒ„è™Ÿ
    print "ç¸½è¡Œè™Ÿ:", NR, "æª”æ¡ˆè¡Œè™Ÿ:", FNR, "æª”æ¡ˆ:", FILENAME, "IP:", $1;
} END {
    print "ç¸½è™•ç†", NR, "è¡Œ";
}' access_part1.log access_part2.log
```

è¼¸å‡ºï¼š

```txt
ç¸½è¡Œè™Ÿ: 1 æª”æ¡ˆè¡Œè™Ÿ: 1 æª”æ¡ˆ: access_part1.log IP: 192.168.0.101
ç¸½è¡Œè™Ÿ: 2 æª”æ¡ˆè¡Œè™Ÿ: 2 æª”æ¡ˆ: access_part1.log IP: 192.168.0.101
ç¸½è¡Œè™Ÿ: 3 æª”æ¡ˆè¡Œè™Ÿ: 3 æª”æ¡ˆ: access_part1.log IP: 203.0.113.45
ç¸½è¡Œè™Ÿ: 4 æª”æ¡ˆè¡Œè™Ÿ: 1 æª”æ¡ˆ: access_part2.log IP: 10.1.2.3
ç¸½è¡Œè™Ÿ: 5 æª”æ¡ˆè¡Œè™Ÿ: 2 æª”æ¡ˆ: access_part2.log IP: 172.16.4.5
ç¸½è¡Œè™Ÿ: 6 æª”æ¡ˆè¡Œè™Ÿ: 3 æª”æ¡ˆ: access_part2.log IP: 203.0.113.45
ç¸½è™•ç† 6 è¡Œ
```

æ¯”è¼ƒå…©å€‹æª”æ¡ˆä¸­çš„ IP åœ°å€å·®ç•°ï¼š

```bash
awk '
FILENAME == "access_part1.log" {ip_part1[$1] = 1}
FILENAME == "access_part2.log" {ip_part2[$1] = 1}
END {
    print "åƒ…åœ¨ç¬¬ä¸€å€‹æª”æ¡ˆä¸­å‡ºç¾çš„ IP:";
    for (ip in ip_part1) {
        if (!(ip in ip_part2)) print ip;
    }
    
    print "åƒ…åœ¨ç¬¬äºŒå€‹æª”æ¡ˆä¸­å‡ºç¾çš„ IP:";
    for (ip in ip_part2) {
        if (!(ip in ip_part1)) print ip;
    }
    
    print "åŒæ™‚å‡ºç¾åœ¨å…©å€‹æª”æ¡ˆä¸­çš„ IP:";
    for (ip in ip_part1) {
        if (ip in ip_part2) print ip;
    }
}' access_part1.log access_part2.log
```

### åˆ†å‰²èˆ‡åˆä½µæ“ä½œ

AWK å¯ä»¥å°‡è¼¸å…¥åˆ†å‰²æˆå¤šå€‹æª”æ¡ˆï¼Œæˆ–å°‡å¤šå€‹æª”æ¡ˆåˆä½µã€‚

æ ¹æ“šç‹€æ…‹ç¢¼å°‡æ—¥èªŒåˆ†å‰²ç‚ºä¸åŒæª”æ¡ˆï¼š

```bash
awk '{
    # æ ¹æ“šç‹€æ…‹ç¢¼å°‡è¨˜éŒ„åˆ†é¡åˆ°ä¸åŒæª”æ¡ˆ
    if ($9 >= 200 && $9 < 300) {
        print > "2xx_success.log";
    } else if ($9 >= 300 && $9 < 400) {
        print > "3xx_redirect.log";
    } else if ($9 >= 400 && $9 < 500) {
        print > "4xx_client_error.log";
    } else {
        print > "other_status.log";
    }
}' log.txt

# æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
awk 'END {print "2xx æˆåŠŸè«‹æ±‚æ•¸:", NR}' 2xx_success.log
awk 'END {print "3xx é‡å®šå‘è«‹æ±‚æ•¸:", NR}' 3xx_redirect.log
awk 'END {print "4xx å®¢æˆ¶ç«¯éŒ¯èª¤è«‹æ±‚æ•¸:", NR}' 4xx_client_error.log
```

è¼¸å‡ºï¼š

```txt
2xx æˆåŠŸè«‹æ±‚æ•¸: 3
3xx é‡å®šå‘è«‹æ±‚æ•¸: 2
4xx å®¢æˆ¶ç«¯éŒ¯èª¤è«‹æ±‚æ•¸: 1
```

æŒ‰ç…§ IP åœ°å€åˆ†å‰²æ—¥èªŒï¼š

```bash
awk '{
    # ç‚ºæ¯å€‹ IP åœ°å€å‰µå»ºå–®ç¨çš„æ—¥èªŒæª”æ¡ˆ
    print > $1 "_requests.log";
}' log.txt

# æª¢æŸ¥æ¯å€‹ IP çš„æ—¥èªŒæ•¸é‡
awk 'END {print "192.168.0.101 è«‹æ±‚æ•¸:", NR}' 192.168.0.101_requests.log
awk 'END {print "203.0.113.45 è«‹æ±‚æ•¸:", NR}' 203.0.113.45_requests.log
```

è¼¸å‡ºï¼š

```txt
192.168.0.101 è«‹æ±‚æ•¸: 2
203.0.113.45 è«‹æ±‚æ•¸: 2
```

åˆä½µå¤šå€‹æª”æ¡ˆä¸¦æ·»åŠ ä¾†æºæ¨™è¨˜ï¼š

```bash
awk '{
    print FILENAME ":", $0;
}' 2xx_success.log 3xx_redirect.log | head -3
```

è¼¸å‡ºï¼š

```txt
2xx_success.log: 192.168.0.101 - - [17/May/2025:21:14:12 +0000] "GET / HTTP/1.1" 200 1536 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "-"
2xx_success.log: 192.168.0.101 - - [17/May/2025:21:16:44 +0000] "GET /dashboard HTTP/1.1" 200 4721 "https://example.com/" "Mozilla/5.0 (iPhone; CPU iPhone OS 16_4 like Mac OS X)" "-"
2xx_success.log: 203.0.113.45 - john [18/May/2025:09:01:11 +0000] "POST /api/upload HTTP/1.1" 201 9832 "https://example.com/upload" "curl/7.68.0" "-"
```

## ğŸ“˜ åˆ†æ Nginx æ—¥èªŒçš„å¯¦éš›æ¡ˆä¾‹

AWK çš„é€²éšå­—ä¸²è™•ç†èƒ½åŠ›è®“è¤‡é›œçš„æ–‡æœ¬è½‰æ›è®Šå¾—ç°¡å–®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ›´æ·±å…¥çš„æŠ€å·§å’Œæ‡‰ç”¨ã€‚

### è§£ææ—¥æœŸæ ¼å¼

```bash
awk '
function parse_month(mon) {
    months["Jan"] = 1; months["Feb"] = 2; months["Mar"] = 3;
    months["Apr"] = 4; months["May"] = 5; months["Jun"] = 6;
    months["Jul"] = 7; months["Aug"] = 8; months["Sep"] = 9;
    months["Oct"] = 10; months["Nov"] = 11; months["Dec"] = 12;
    return months[mon];
}

{
    # å¾ [17/May/2025:21:14:12 +0000] æå–æ—¥æœŸæ™‚é–“
    if (match($4, /\[([0-9]+)\/([A-Za-z]+)\/([0-9]+):([0-9]+):([0-9]+):([0-9]+)/, dt)) {
        day = dt[1];
        month = parse_month(dt[2]);
        year = dt[3];
        hour = dt[4];
        minute = dt[5];
        second = dt[6];
        
        printf "ISOæ ¼å¼æ—¥æœŸæ™‚é–“: %s-%02d-%02d %s:%s:%s\n", 
               year, month, day, hour, minute, second;
        
        timestamp = mktime(sprintf("%s %02d %02d %s %s %s", 
                           year, month, day, hour, minute, second));
        print "Unix æ™‚é–“æˆ³:", timestamp;
    }
}' log.txt | head -4
```

è¼¸å‡ºï¼š

```txt
ISOæ ¼å¼æ—¥æœŸæ™‚é–“: 2025-05-17 21:14:12
Unix æ™‚é–“æˆ³: 1747516452
ISOæ ¼å¼æ—¥æœŸæ™‚é–“: 2025-05-17 21:16:44
Unix æ™‚é–“æˆ³: 1747516604
```

### è¼¸å‡ºæ’ç‰ˆ

```bash
awk 'BEGIN {
    # å ±è¡¨æ¨™é¡Œ
    printf "%-15s %-23s %-7s %-25s %-6s %s\n", 
           "IPåœ°å€", "æ™‚é–“", "æ–¹æ³•", "URL", "ç‹€æ…‹", "å¤§å°";
    printf "%s\n", "----------------------------------------------------------------------";
}

{
    # æ¸…ç†å’Œæ ¼å¼åŒ–æ•¸æ“š
    gsub(/\"/, "", $6);  # ç§»é™¤å¼•è™Ÿ
    datetime = substr($4, 2) " " substr($5, 1, length($5)-1);
    
    # æˆªæ–·é•· URL
    url = $7;
    if (length(url) > 25) {
        url = substr(url, 1, 22) "...";
    }
    
    # è¼¸å‡ºæ ¼å¼åŒ–è¡Œ
    printf "%-15s %-23s %-7s %-25s %-6s %s\n", 
           $1, datetime, $6, url, $9, $10;
}

END {
    printf "%s\n", "----------------------------------------------------------------------";
    printf "å…±è™•ç† %d æ¢è¨˜éŒ„\n", NR;
}' log.txt
```

### è¼¸å‡º HTML

AWK çš„è¼¸å‡ºæ ¼å¼åŒ–åŠŸèƒ½è®“å ±è¡¨ç”Ÿæˆå’Œæ•¸æ“šå‘ˆç¾æ›´åŠ å°ˆæ¥­ã€‚

```bash
awk 'BEGIN {
    print "<html><head><style>";
    print "table { border-collapse: collapse; width: 100%; }";
    print "th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }";
    print "th { background-color: #f2f2f2; }";
    print "tr:nth-child(even) { background-color: #f9f9f9; }";
    print "</style></head><body>";
    print "<h2>Nginx è¨ªå•æ—¥èªŒåˆ†æ</h2>";
    print "<table>";
    print "<tr><th>IP</th><th>æ™‚é–“</th><th>æ–¹æ³•</th><th>URL</th><th>ç‹€æ…‹</th><th>å¤§å°</th></tr>";
}

{
    # æ¸…ç†æ•¸æ“š
    gsub(/\"/, "", $6);  # ç§»é™¤ HTTP æ–¹æ³•ä¸­çš„å¼•è™Ÿ
    
    # æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    datetime = substr($4, 2) " " substr($5, 1, length($5)-1);
    
    print "<tr>";
    print "<td>" $1 "</td>";
    print "<td>" datetime "</td>";
    print "<td>" $6 "</td>";
    print "<td>" $7 "</td>";
    print "<td>" $9 "</td>";
    print "<td>" $10 "</td>";
    print "</tr>";
}

END {
    print "</table>";
    print "<p>å ±è¡¨ç”Ÿæˆæ™‚é–“: " strftime("%Y-%m-%d %H:%M:%S") "</p>";
    print "</body></html>";
}' log.txt > access_report.html

echo "å·²ç”Ÿæˆ HTML å ±è¡¨ï¼šaccess_report.html"
```

è¼¸å‡ºï¼š

```txt
å·²ç”Ÿæˆ HTML å ±è¡¨ï¼šaccess_report.html
```

### è¼¸å‡º CSV

ç”Ÿæˆ CSV æ ¼å¼è¼¸å‡ºï¼š

```bash
awk 'BEGIN {
    # åŠ å…¥ UTF-8 BOMï¼ˆByte Order Markï¼‰
    printf "\xEF\xBB\xBF";

    print "IP,æ™‚é–“,æ–¹æ³•,URL,ç‹€æ…‹ç¢¼,éŸ¿æ‡‰å¤§å°,ç”¨æˆ¶ä»£ç†";
    FS = " ";
}

{
    # æ¸…ç†å­—æ®µ
    gsub(/\"/, "", $6);  # ç§»é™¤æ–¹æ³•ä¸­çš„å¼•è™Ÿ
    
    # æå–æ—¥æœŸæ™‚é–“ä¸¦æ ¼å¼åŒ–
    datetime = $4;
    gsub(/[\[\]]/, "", datetime);
    
    # æå–ç”¨æˆ¶ä»£ç†
    ua = "";
    for (i = 12; i <= NF-1; i++) {
        ua = ua (i > 12 ? " " : "") $i;
    }
    gsub(/\"/, "", ua);  # ç§»é™¤å¼•è™Ÿ
    gsub(/,/, ";", ua);  # æ›¿æ›é€—è™Ÿä»¥é¿å… CSV æ ¼å¼å•é¡Œ
    
    # è¼¸å‡º CSV è¡Œ
    printf "%s,%s,%s,%s,%s,%s,\"%s\"\n", 
           $1, datetime, $6, $7, $9, $10, ua;
}' log.txt > access_data.csv

echo "å·²ç”Ÿæˆ CSV æ•¸æ“šï¼šaccess_data.csv"
```

è¼¸å‡ºï¼š

```txt
å·²ç”Ÿæˆ CSV æ•¸æ“šï¼šaccess_data.csv
```

### è¤‡é›œè³‡æ–™è™•ç†

AWK å¯ä»¥è™•ç†è¤‡é›œçš„æ•¸æ“šåˆ†æä»»å‹™ï¼ŒåŒ…æ‹¬çµ±è¨ˆã€èšåˆå’Œé—œè¯åˆ†æã€‚

æŒ‰å°æ™‚çµ±è¨ˆè¨ªå•é‡ï¼š

> éœ€è¦ gawkã€‚

```bash
awk '{
    # å¾æ™‚é–“æˆ³ä¸­æå–å°æ™‚
    if (match($4, /:([0-9][0-9]):/, hour)) {
        hours[hour[1]]++;
    }
} 

END {
    print "æ¯å°æ™‚è¨ªå•çµ±è¨ˆ:";
    for (h in hours) {
        printf "%sé»: ", h;
        for (i = 0; i < hours[h]; i++) printf "â– ";
        printf " (%d)\n", hours[h];
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
æ¯å°æ™‚è¨ªå•çµ±è¨ˆ:
21é»: â– â– â– â– â–  (5)
09é»: â–  (1)
```

è¨ªå•è·¯å¾‘åˆ†æï¼š

> éœ€è¦ gawkã€‚

```bash
awk '{
    # æå– URL è·¯å¾‘çš„ç¬¬ä¸€ç´šç›®éŒ„
    url = $7;
    if (url == "/") {
        paths["é¦–é "]++;
    } else if (match(url, /\/([^\/]+)/, path)) {
        paths[path[1]]++;
    }
    
    # è¨˜éŒ„è¨ªå•é †åº
    if (last_ip == $1) {
        path_seq[path_count++] = url;
    } else {
        if (path_count > 0) {
            print "ç”¨æˆ¶è¨ªå•è·¯å¾‘:";
            for (i = 0; i < path_count; i++) {
                printf "%s%s", path_seq[i], (i < path_count-1) ? " â†’ " : "\n";
            }
        }
        path_count = 0;
        path_seq[path_count++] = url;
        last_ip = $1;
    }
} 

END {
    # æ‰“å°æœ€å¾Œä¸€å€‹ç”¨æˆ¶çš„è·¯å¾‘
    if (path_count > 0) {
        print "ç”¨æˆ¶è¨ªå•è·¯å¾‘:";
        for (i = 0; i < path_count; i++) {
            printf "%s%s", path_seq[i], (i < path_count-1) ? " â†’ " : "\n";
        }
    }
    
    print "\nè·¯å¾‘è¨ªå•çµ±è¨ˆ:";
    for (p in paths) {
        printf "%s: %d æ¬¡\n", p, paths[p];
    }
}' log.txt
```

è¨ˆç®—æ¯å€‹ç”¨æˆ¶çš„å¹³å‡è«‹æ±‚å¤§å°ï¼š

```bash
awk '{
    # ç´¯åŠ æ¯å€‹ IP çš„è«‹æ±‚å¤§å°
    ip_bytes[$1] += $10;
    ip_count[$1]++;
}

END {
    print "ç”¨æˆ¶å¹³å‡è«‹æ±‚å¤§å°:";
    for (ip in ip_bytes) {
        avg = ip_bytes[ip] / ip_count[ip];
        printf "%s: ç¸½ %d ä½å…ƒçµ„, %d è«‹æ±‚, å¹³å‡ %.1f ä½å…ƒçµ„\n", 
               ip, ip_bytes[ip], ip_count[ip], avg;
    }
}' log.txt
```

è¼¸å‡ºï¼š

```txt
ç”¨æˆ¶å¹³å‡è«‹æ±‚å¤§å°:
192.168.0.101: ç¸½ 6257 ä½å…ƒçµ„, 2 è«‹æ±‚, å¹³å‡ 3128.5 ä½å…ƒçµ„
203.0.113.45: ç¸½ 10255 ä½å…ƒçµ„, 2 è«‹æ±‚, å¹³å‡ 5127.5 ä½å…ƒçµ„
10.1.2.3: ç¸½ 0 ä½å…ƒçµ„, 1 è«‹æ±‚, å¹³å‡ 0.0 ä½å…ƒçµ„
172.16.4.5: ç¸½ 732 ä½å…ƒçµ„, 1 è«‹æ±‚, å¹³å‡ 732.0 ä½å…ƒçµ„
```
